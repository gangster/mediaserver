name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect what files changed to skip unnecessary jobs
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      deps: ${{ steps.filter.outputs.deps }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'packages/**'
              - 'apps/**'
              - 'tsconfig*.json'
              - 'nx.json'
              - '.nvmrc'
            deps:
              - 'package.json'
              - 'yarn.lock'
              - 'packages/*/package.json'
              - 'apps/*/package.json'
            docs:
              - '*.md'
              - 'docs/**'
              - '.github/ISSUE_TEMPLATE/**'
              - '.github/PULL_REQUEST_TEMPLATE.md'

  # Security audit - only runs when dependencies change
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.deps == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run security audit
        run: yarn npm audit --environment production --severity high
        continue-on-error: false

  # Lint and typecheck
  lint:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.code == 'true' || needs.changes.outputs.deps == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Enable Corepack
        run: corepack enable

      - name: Get yarn cache directory
        id: yarn-cache-dir
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-${{ hashFiles('yarn.lock') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nx-${{ hashFiles('yarn.lock') }}-
            ${{ runner.os }}-nx-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Build packages
        run: yarn nx run-many -t build --projects='@mediaserver/*'

      - name: Typecheck
        run: yarn nx run-many -t typecheck

      - name: Lint
        run: yarn nx run-many -t lint

  # Unit tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [changes]
    if: ${{ needs.changes.outputs.code == 'true' || needs.changes.outputs.deps == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'

      - name: Enable Corepack
        run: corepack enable

      - name: Get yarn cache directory
        id: yarn-cache-dir
        run: echo "dir=$(yarn config get cacheFolder)" >> $GITHUB_OUTPUT

      - name: Cache yarn dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.yarn-cache-dir.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Cache Nx
        uses: actions/cache@v4
        with:
          path: .nx/cache
          key: ${{ runner.os }}-nx-test-${{ hashFiles('yarn.lock') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nx-test-${{ hashFiles('yarn.lock') }}-
            ${{ runner.os }}-nx-test-

      - name: Install dependencies
        run: yarn install --immutable

      - name: Run unit tests
        run: yarn nx run-many -t test

  # Summary job - required status check
  ci:
    name: CI
    runs-on: ubuntu-latest
    needs: [changes, security, lint, unit-tests]
    if: always()
    steps:
      - name: Check required jobs
        run: |
          echo "Changes - code: ${{ needs.changes.outputs.code }}, deps: ${{ needs.changes.outputs.deps }}, docs: ${{ needs.changes.outputs.docs }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          
          # For dependency changes, security audit must pass
          if [[ "${{ needs.changes.outputs.deps }}" == "true" ]]; then
            if [[ "${{ needs.security.result }}" != "success" ]]; then
              echo "Security audit failed"
              exit 1
            fi
          fi
          
          # For code or deps changes, all code jobs must pass
          if [[ "${{ needs.changes.outputs.code }}" == "true" || "${{ needs.changes.outputs.deps }}" == "true" ]]; then
            if [[ "${{ needs.lint.result }}" != "success" ]]; then
              echo "Lint failed"
              exit 1
            fi
            if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
              echo "Unit tests failed"
              exit 1
            fi
          fi
          
          echo "All required checks passed!"
